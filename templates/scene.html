<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>场景页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2, h3, p, ul {
            margin: 0;
            padding: 0;
            font-size: 16px;
            text-align: left;
        }
        a {
            display: inline-block;
            text-decoration: none;
            color: #0066cc;
        }
        a:hover {
            text-decoration: underline;
            color: #003366;
        }
        .section {
            margin: 10px 0;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .map-container {
            margin: 8px 0;
            padding: 3px;
            background: #f5f5f5;
            border-radius: 3px;
            width: 240px;
        }
        .map-grid {
            display: grid;
            grid-template-columns: 70px 70px 70px;
            gap: 1px;
            text-align: center;
            font-size: 11px;
        }
        .map-cell {
            padding: 1px 2px;
            min-height: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .map-cell.current {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 2px;
            font-weight: bold;
            padding: 1px 3px;
        }
        .map-cell.exit {
            color: #0066cc;
            font-size: 10px;
        }
        .chat-message {
            background-color: #f0f0f0;
            padding: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    {% if player.last_chat_message %}
        <div class="chat-message">
            {% if player.last_chat_message.is_gift %}
                【赠送】{{ player.last_chat_message.sender }}{{ player.last_chat_message.content }}
            {% else %}
                【私聊】{{ player.last_chat_message.sender }}对你说：{{ player.last_chat_message.content }}
            {% endif %}
        </div>
    {% endif %}

    <div class="section">
        <a href="{{ url_for('scene') }}" class="refresh-btn">刷新</a>
        <a href="{{ url_for('shop') }}">商城</a>
    </div>

    <h1>{{ location.name }}（{{ location.area_name }}）</h1>

    <div style="margin: 5px 0;">
        <a href="javascript:void(0)" onclick="toggleMap()" id="mapToggle">关地图</a>
    </div>

    <div class="map-container" id="mapContainer">
        <div class="map-grid">
            <!-- 北方区域及其延伸出口 -->
            <div class="map-cell exit">
                {% if location.north_exit and locations[location.north_exit].west_exit %}
                    {{ locations[locations[location.north_exit].west_exit].name }}
                {% endif %}
            </div>
            <div class="map-cell exit">
                {% if location.north_exit %}
                    {{ locations[location.north_exit].name }}
                    {% if locations[location.north_exit].north_exit %}
                        <br>{{ locations[locations[location.north_exit].north_exit].name }}
                    {% endif %}
                {% endif %}
            </div>
            <div class="map-cell exit">
                {% if location.north_exit and locations[location.north_exit].east_exit %}
                    {{ locations[locations[location.north_exit].east_exit].name }}
                {% endif %}
            </div>
            
            <!-- 中间区域（西-当前-东） -->
            <div class="map-cell exit">
                {% if location.west_exit %}
                    {{ locations[location.west_exit].name }}
                    {% if locations[location.west_exit].west_exit %}
                        <br>{{ locations[locations[location.west_exit].west_exit].name }}
                    {% endif %}
                {% endif %}
            </div>
            <div class="map-cell current">{{ location.name }}</div>
            <div class="map-cell exit">
                {% if location.east_exit %}
                    {{ locations[location.east_exit].name }}
                    {% if locations[location.east_exit].east_exit %}
                        <br>{{ locations[locations[location.east_exit].east_exit].name }}
                    {% endif %}
                {% endif %}
            </div>
            
            <!-- 南方区域及其延伸出口 -->
            <div class="map-cell exit">
                {% if location.south_exit and locations[location.south_exit].west_exit %}
                    {{ locations[locations[location.south_exit].west_exit].name }}
                {% endif %}
            </div>
            <div class="map-cell exit">
                {% if location.south_exit %}
                    {{ locations[location.south_exit].name }}
                    {% if locations[location.south_exit].south_exit %}
                        <br>{{ locations[locations[location.south_exit].south_exit].name }}
                    {% endif %}
                {% endif %}
            </div>
            <div class="map-cell exit">
                {% if location.south_exit and locations[location.south_exit].east_exit %}
                    {{ locations[locations[location.south_exit].east_exit].name }}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="section">
        {% if location.north_exit %}
            北:↑ <a href="{{ url_for('move', direction='north') }}">{{ locations[location.north_exit].name }}</a><br>
        {% endif %}
        
        {% if location.west_exit or location.east_exit %}
            {% if location.west_exit %}
                西:← <a href="{{ url_for('move', direction='west') }}">{{ locations[location.west_exit].name }}</a>
            {% endif %}
            {% if location.east_exit %}
                东:→ <a href="{{ url_for('move', direction='east') }}">{{ locations[location.east_exit].name }}</a>
            {% endif %}
            <br>
        {% endif %}
        
        {% if location.south_exit %}
            南:↓ <a href="{{ url_for('move', direction='south') }}">{{ locations[location.south_exit].name }}</a>
        {% endif %}
    </div>

    <div class="section">
        怪物：
        {% if monster.killable %}
            <a href="{{ url_for('battle') }}">{{ monster.name }}({{ monster.level }}级)</a>
        {% else %}
            <a href="{{ url_for('view_npc', monster_id=monster.monster_id) }}">{{ monster.name }}({{ monster.level }}级)</a>
        {% endif %}
    </div>

    <div class="section">
        {% if location.ground_items %}
            地上物品：
            {% for item_id in location.ground_items %}
                <a href="{{ url_for('pickup_item', item_id=item_id) }}">
                    {{ Item.load_items()[item_id].name }}
                </a>
            {% endfor %}
        {% endif %}
    </div>

    <div class="section">
        <p>玩家：{% if other_players %}
            {% for other_player in other_players %}
                <a href="{{ url_for('view_player', username=other_player.username) }}">{{ other_player.name }}</a>{% if not loop.last %},{% endif %}
            {% endfor %}
        {% else %}
            无
        {% endif %}</p>
    </div>

    <div class="section">
        <a href="{{ url_for('character') }}">角色</a>
        <a href="{{ url_for('inventory') }}">背包</a>
        <a href="{{ url_for('chat') }}">聊天</a>
    </div>

    <div class="section">
        三国时间：{{ now.strftime('%Y-%m-%d %H:%M:%S') }}
    </div>

    <div>
        <a href="{{ url_for('logout') }}">退出游戏</a>
    </div>

    <script>
        function toggleMap() {
            const mapContainer = document.getElementById('mapContainer');
            const mapToggle = document.getElementById('mapToggle');
            if (mapContainer.style.display === 'none') {
                mapContainer.style.display = 'block';
                mapToggle.textContent = '关地图';
            } else {
                mapContainer.style.display = 'none';
                mapToggle.textContent = '开地图';
            }
        }
    </script>
</body>
</html>
